(function(){var k=UM.utils,n=UM.browser,g={checkURL:function(a){if(!a)return!1;a=k.trim(a);if(0>=a.length)return!1;0!==a.search(/http:\/\/|https:\/\//)&&(a+="http://");a=a.replace(/\?[\s\S]*$/,"");return/(.gif|.jpg|.jpeg|.png)$/i.test(a)?a:!1},getAllPic:function(a,b,c){var d=[];a=$(a,b);$.each(a,function(a,b){$(b).removeAttr("width").removeAttr("height");return d.push({_src:b.src,src:b.src})});return d},scale:function(a,b,c,d){var e=0,e=0;c=a.width||c;d=a.height||d;if(c>b||d>b)if(c>=d){if(e=c-b)e=(e/c).toFixed(2),a.height=d-d*e,a.width=b}else if(e=d-b)e=(e/d).toFixed(2),a.width=c-c*e,a.height=b;return this},close:function(a){a.css({top:(a.parent().height()-a.height())/2,left:(a.parent().width()-a.width())/2}).prev().on("click",function(){$(this).parent().remove().hasClass("edui-image-upload-item")&&(f.showCount--,f.updateView())});return this},createImgBase64:function(a,b,c){if(n.webkit)a.src=window.webkitURL.createObjectURL(b);else if(n.gecko)a.src=window.URL.createObjectURL(b);else{var d=new FileReader;d.onload=function(b){a.src=this.result;c.append(a)};d.readAsDataURL(b)}},callback:function(a,b,c,d){"SUCCESS"==d?(f.showCount++,a=$("\x3cimg src\x3d'"+a.options.imagePath+c+"' class\x3d'edui-image-pic' /\x3e"),c=$("\x3cdiv class\x3d'edui-image-item edui-image-upload-item'\x3e\x3cdiv class\x3d'edui-image-close'\x3e\x3c/div\x3e\x3c/div\x3e").append(a),1>$(".edui-image-upload2",b).length?($(".edui-image-content",b).append(c),f.render(".edui-image-content",2).config(".edui-image-upload2")):$(".edui-image-upload2",b).before(c).show(),a.on("load",function(){g.scale(this,120);g.close($(this));$(".edui-image-content",b).focus()})):(l.showTip(d),window.setTimeout(function(){l.hideTip()},3E3));f.toggleMask()}},f={showCount:0,uploadTpl:'\x3cdiv class\x3d"edui-image-upload%%"\x3e\x3cspan class\x3d"edui-image-icon"\x3e\x3c/span\x3e\x3cform class\x3d"edui-image-form" method\x3d"post" enctype\x3d"multipart/form-data" target\x3d"up"\x3e\x3cinput style\x3d"filter: alpha(opacity\x3d0);" class\x3d"edui-image-file" type\x3d"file" hidefocus name\x3d"upfile" accept\x3d"image/gif,image/jpeg,image/png,image/jpg,image/bmp"/\x3e\x3c/form\x3e\x3c/div\x3e',init:function(a,b){this.editor=a;this.dialog=b;this.render(".edui-image-local",1);this.config(".edui-image-upload1");this.submit();$(".edui-image-upload1").hover(function(){$(".edui-image-icon",this).toggleClass("hover")});UM.browser.ie&&9>=UM.browser.version||$(".edui-image-dragTip",this.dialog).css("display","block");return this},render:function(a,b){$(a,this.dialog).append($(this.uploadTpl.replace(/%%/g,b)));return this},config:function(a){var b=this.editor.options.imageUrl,b=b+(-1==b.indexOf("?")?"?":"\x26")+"editorid\x3d"+this.editor.id,c=k.serializeParam(this.editor.queryCommandValue("serverparam"))||"",b=k.formatUrl(b+(-1==b.indexOf("?")?"?":"\x26")+c);$("form",$(a,this.dialog)).attr("action",b);return this},uploadComplete:function(a){try{var b=eval("("+a+")");g.callback(this.editor,this.dialog,b.url,b.state)}catch(c){a=this.editor.getLang("image"),g.callback(this.editor,this.dialog,"",a&&a.uploadError||"Error!")}},submit:function(a){var b=this,c=$('\x3cinput style\x3d"filter: alpha(opacity\x3d0);" class\x3d"edui-image-file" type\x3d"file" hidefocus\x3d"" name\x3d"upfile" accept\x3d"image/gif,image/jpeg,image/png,image/jpg,image/bmp"\x3e'),c=c[0];$(b.dialog).delegate(".edui-image-file","change",function(d){this.parentNode&&($('\x3ciframe name\x3d"up"  style\x3d"display: none"\x3e\x3c/iframe\x3e').insertBefore(b.dialog).on("load",function(){var a=this.contentWindow.document.body.innerHTML;""!=a&&(b.uploadComplete(a),$(this).unbind("load"),$(this).remove())}),$(this).parent()[0].submit(),f.updateInput(c),b.toggleMask("Loading...."),a&&a())});return b},updateInput:function(a){$(".edui-image-file",this.dialog).each(function(b,c){c.parentNode.replaceChild(a.cloneNode(!0),c)})},updateView:function(){0===f.showCount&&($(".edui-image-upload2",this.dialog).hide(),$(".edui-image-dragTip",this.dialog).show(),$(".edui-image-upload1",this.dialog).show())},drag:function(){var a=this;if(!UM.browser.ie9below)a.dialog.find(".edui-image-content").on("drop",function(b){var c=b.originalEvent.dataTransfer.files,d=document.createElement("img"),e=!1;$.each(c,function(b,f){if(/^image/.test(f.type)){g.createImgBase64(d,f,a.dialog);var m=new XMLHttpRequest,h=a.editor.getOpt("imageUrl")+"?type\x3dajax",l=k.serializeParam(a.editor.queryCommandValue("serverparam"))||"",h=k.formatUrl(h+(-1==h.indexOf("?")?"?":"\x26")+l);m.open("post",h,!0);m.setRequestHeader("X-Requested-With","XMLHttpRequest");h=new FormData;h.append(a.editor.getOpt("imageFieldName"),f);m.send(h);m.addEventListener("load",function(e){a.uploadComplete(e.target.response);b==c.length-1&&$(d).remove()});e=!0}});e&&(b.preventDefault(),a.toggleMask("Loading...."))}).on("dragover",function(a){a.preventDefault()})},toggleMask:function(a){var b=$(".edui-image-mask",this.dialog);if(a)UM.browser.ie&&9>=UM.browser.version||$(".edui-image-dragTip",this.dialog).css("display","none"),$(".edui-image-upload1",this.dialog).css("display","none"),b.addClass("edui-active").html(a);else{b.removeClass("edui-active").html();if(0<f.showCount)return this;UM.browser.ie&&9>=UM.browser.version||$(".edui-image-dragTip",this.dialog).css("display","block");$(".edui-image-upload1",this.dialog).css("display","block")}return this}},q={init:function(a,b){this.editor=a;this.dialog=b;this.initEvt()},initEvt:function(){var a=this,b,c=$(".edui-image-searchTxt",a.dialog);$(".edui-image-searchAdd",a.dialog).on("click",function(){if(b=g.checkURL(c.val()))$("\x3cimg src\x3d'"+b+"' class\x3d'edui-image-pic' /\x3e").on("load",function(){var b=$("\x3cdiv class\x3d'edui-image-item'\x3e\x3cdiv class\x3d'edui-image-close'\x3e\x3c/div\x3e\x3c/div\x3e").append(this);$(".edui-image-searchRes",a.dialog).append(b);g.scale(this,120);b.width($(this).width());g.close($(this));c.val("")})}).hover(function(){$(this).toggleClass("hover")})}},p=null,l=null;UM.registerWidget("image",{tpl:'\x3clink rel\x3d"stylesheet" type\x3d"text/css" href\x3d"\x3c%\x3dimage_url%\x3eimage.css"\x3e\x3cdiv class\x3d"edui-image-wrapper"\x3e\x3cul class\x3d"edui-tab-nav"\x3e\x3cli class\x3d"edui-tab-item edui-active"\x3e\x3ca data-context\x3d".edui-image-local" class\x3d"edui-tab-text"\x3e\x3c%\x3dlang_tab_local%\x3e\x3c/a\x3e\x3c/li\x3e\x3cli  class\x3d"edui-tab-item"\x3e\x3ca data-context\x3d".edui-image-JimgSearch" class\x3d"edui-tab-text"\x3e\x3c%\x3dlang_tab_imgSearch%\x3e\x3c/a\x3e\x3c/li\x3e\x3c/ul\x3e\x3cdiv class\x3d"edui-tab-content"\x3e\x3cdiv class\x3d"edui-image-local edui-tab-pane edui-active"\x3e\x3cdiv class\x3d"edui-image-content"\x3e\x3c/div\x3e\x3cdiv class\x3d"edui-image-mask"\x3e\x3c/div\x3e\x3cdiv class\x3d"edui-image-dragTip"\x3e\x3c%\x3dlang_input_dragTip%\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"edui-image-JimgSearch edui-tab-pane"\x3e\x3cdiv class\x3d"edui-image-searchBar"\x3e\x3ctable\x3e\x3ctr\x3e\x3ctd\x3e\x3cinput class\x3d"edui-image-searchTxt" type\x3d"text"\x3e\x3c/td\x3e\x3ctd\x3e\x3cdiv class\x3d"edui-image-searchAdd"\x3e\x3c%\x3dlang_btn_add%\x3e\x3c/div\x3e\x3c/td\x3e\x3c/tr\x3e\x3c/table\x3e\x3c/div\x3e\x3cdiv class\x3d"edui-image-searchRes"\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e',initContent:function(a,b){var c=a.getLang("image")["static"],d=$.extend({},c,{image_url:UMEDITOR_CONFIG.UMEDITOR_HOME_URL+"dialogs/image/"});f.showCount=0;if(c)var e=$.parseTmpl(this.tpl,d);l=b.edui();this.root().html(e)},initEvent:function(a,b){p=$.eduitab({selector:".edui-image-wrapper"}).edui().on("beforeshow",function(a){a.stopPropagation()});f.init(a,b);q.init(a,b)},buttons:{ok:{exec:function(a,b){var c="",d=p.activate();0==d?c=".edui-image-content .edui-image-pic":1==d&&(c=".edui-image-searchRes .edui-image-pic");c=g.getAllPic(c,b,a);-1!=d&&a.execCommand("insertimage",c)}},cancel:{}},width:700,height:408},function(a,b,c,d){g.callback(a,b,c,d)})})();